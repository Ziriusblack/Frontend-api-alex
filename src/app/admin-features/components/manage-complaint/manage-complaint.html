<navigation-bar></navigation-bar>

<div class="max-w-5xl mx-auto mt-10 bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
  <h1 class="text-3xl font-bold text-orange-500 mb-6 text-center">Gestionar Radicado</h1>

  <!-- 🔄 Loading Indicator -->
  @if (loading) {
    <div class="flex flex-col items-center justify-center py-8">
      <div class="animate-spin rounded-full h-10 w-10 border-t-4 border-orange-500 border-solid mb-3"></div>
      <p class="text-gray-600 text-sm font-medium">Cargando información...</p>
    </div>
  }

  <!-- ⚠️ Error Message -->
  @if (error) {
    <div class="flex items-center justify-center py-4 px-6 bg-red-100 border border-red-400 text-red-700 rounded-xl shadow-sm mb-6">
      <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" stroke-width="2" 
           viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 9v2m0 4h.01M21 12A9 9 0 1 1 3 12a9 9 0 0 1 18 0z" />
      </svg>
      <p class="font-semibold">{{ error }}</p>
    </div>
  }

  <!-- 📄 Detalles del Radicado -->
  @if (!loading && !error && complaint) {
    <div class="bg-gray-50 rounded-xl p-6 mb-8 border border-gray-200">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Detalles del Radicado</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
        <p><strong>ID:</strong> {{ complaint.reference }}</p>
        <p><strong>Usuario:</strong> {{ showUserFullName(complaint.userProfile) }}</p>
        <p><strong>Correo:</strong> {{ showUserEmail(complaint.userProfile) }}</p>
        <p><strong>Estado:</strong> {{ showStatusName(complaint.status) }}</p>
        <p><strong>Tipo:</strong> {{ showTypeName(complaint.type) }}</p>
        <p><strong>Categoría:</strong> {{ showCategoryName(complaint.category) }}</p>
        <p><strong>Asunto:</strong> {{ complaint.subject }}</p>
        <p><strong>Descripción:</strong> {{ complaint.description }}</p>
        <p><strong>Fecha Creación:</strong> {{ complaint.recievedDate | date:'short' }}</p>
        <p><strong>Última Actualización:</strong> {{ complaint.updatedDate | date:'short' }}</p>
      </div>

      @if (complaint.traceability && complaint.traceability.length > 0) {
        <div class="mt-6">
          <h3 class="text-lg font-semibold text-orange-600 mb-3">Historial de Cambios</h3>
          <ul class="list-disc pl-5 text-gray-600">
            @for (trace of complaint.traceability; track $index) {
              <li>
                <strong>{{ trace.date | date:'short' }}:</strong> {{ trace.status }} realizado por {{ showPerformedBy(trace) }}
              </li>
            }
          </ul>
        </div>
      }
    </div>
  }

  <!-- 🧾 Formulario de Actualización -->
  <form 
    [formGroup]="complaintForm" 
    (ngSubmit)="updateComplaint()" 
    class="space-y-6 bg-gray-50 p-6 rounded-xl border border-gray-200">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Estado -->
      <div>
        <label for="status" class="block text-sm font-semibold text-gray-700 mb-1">Estado</label>
        <select id="status" formControlName="status" required
          class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 p-2">
          @for (item of statusNames; track $index) {  
            <option [value]=$index>{{ item }}</option>
          }
        </select>
        @if (status?.invalid && (status?.dirty || status?.touched)) {
          <p class="text-red-600 text-sm mt-1">Este campo es obligatorio.</p>
        }
      </div>

      <!-- Dependencia -->
      <div>
        <label for="department" class="block text-sm font-semibold text-gray-700 mb-1">Dependencia</label>
        <input 
          id="department" 
          type="text" 
          formControlName="department" 
          maxlength="101"
          placeholder="Ej: Atención al ciudadano"
          class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 p-2">
        @if (department?.invalid && (department?.dirty || department?.touched)) {
          <p class="text-red-600 text-sm mt-1">Máximo 100 caracteres permitidos.</p>
        }
      </div>
    </div>

    <!-- Respuesta -->
    <div>
      <label for="response" class="block text-sm font-semibold text-gray-700 mb-1">Respuesta</label>
      <textarea 
        id="response" 
        rows="4" 
        formControlName="response" 
        maxlength="801"
        placeholder="Escribe la respuesta del radicado..."
        class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 p-2 resize-none"></textarea>
      @if (response?.invalid && (response?.dirty || response?.touched)) {
        <p class="text-red-600 text-sm mt-1">Máximo 800 caracteres permitidos.</p>
      }
    </div>

    <!-- Botón Actualizar -->
    <div class="flex justify-end">
      <button 
        type="submit" 
        [disabled]="!complaintForm.valid"
        class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-semibold shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed">
        Actualizar
      </button>
    </div>
  </form>
</div>
